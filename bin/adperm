#!/bin/bash
#-*- coding: utf-8 -*-
#1#_SCRIPT_#1# - by: Francis Demers <steelalive@github.com>
#2#::.. Last edit: - Sun Dec 22 15:52:07 EST 2019 ..::## #_# - VERSION=0.0.0.1 - #_# #@#2019-12-22#@# #2#
# vi: ft=sh
#3#::..#####################_/dot/bin/adperm_#######################..::#3#

script_dir() {
	local SOURCE DIR
	SOURCE="${BASH_SOURCE[0]}"
	while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
		DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
		SOURCE="$(readlink "$SOURCE")"
		[[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
	done
	echo "$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
}
adperm() {
	MODTITLE=dot
	AUTHOR=Frank
	apkdir=$1
	name=$(aapt d badging $1 | head -n1 | awk '{print $2}')
	name=$(echo ${name#*=} | tr -d ' ' | tr -d "'")
	SYSTEM2=$sys
	pp=0
	app_perm=()
	perm=()
	for i in $(aapt d permissions $apkdir | grep -v 'package:' | awk '{print $2}'); do
		_perm=$(echo ${i#*=} | tr -d "'")
		perm[pp]=$_perm
		pp=$((pp + 1))
	done
	app_perm=($(echo "${perm[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
	echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>
<!--
	Generated by $MODTITLE by $AUTHOR
-->
<permissions>
    <privapp-permissions package=\"${name}\">" >>$MODDIR$SYSTEM2/etc/permissions/privapp-permissions-${name}.xml
	for i in ${app_perm[@]}; do
		echo "        <permission name=\"$i\"/>" >>$MODDIR$SYSTEM2/etc/permissions/privapp-permissions-${name}.xml
	done
	echo "    </privapp-permissions>
</permissions>" >>$MODDIR$SYSTEM2/etc/permissions/privapp-permissions-${name}.xml
	chmod 644 $MODDIR$SYSTEM2/etc/permissions/privapp-permissions-${name}.xml
}
adperm "$@"
